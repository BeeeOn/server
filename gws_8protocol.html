<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>BeeeOn Server: Gateway Server Protocol</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="BeeeOn.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">BeeeOn Server
   &#160;<span id="projectnumber">v2018.11.1</span>
   </div>
   <div id="projectbrief">Platform to interconnect the IoT world</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Gateway Server Protocol </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#gws_protocol_introduction">Introduction</a></li>
<li class="level1"><a href="#gws_protocol_initial">Initial sequence</a></li>
<li class="level1"><a href="#gws_protocol_command">Command requests</a></li>
<li class="level1"><a href="#gws_protocol_issues">Known issues</a></li>
<li class="level1"><a href="#gws_registration">Registration with server</a><ul><li class="level2"><a href="#gws_GWGatewayRegister">GWGatewayRegister</a></li>
<li class="level2"><a href="#gws_GWGatewayAccepted">GWGatewayAccepted</a></li>
</ul>
</li>
<li class="level1"><a href="#gws_generic">Generic messages</a><ul><li class="level2"><a href="#gws_GWResponse">GWResponse</a></li>
<li class="level2"><a href="#gws_GWResponseWithAck">GWResponseWithAck</a></li>
<li class="level2"><a href="#gws_GWAck">GWAck</a></li>
</ul>
</li>
<li class="level1"><a href="#gws_gwtoserver">Requests from gateway</a><ul><li class="level2"><a href="#gws_GWNewDeviceRequest">GWNewDeviceRequest</a></li>
<li class="level2"><a href="#gws_GWNewDeviceGroupRequest">GWNewDeviceGroupRequest</a></li>
<li class="level2"><a href="#gws_GWDeviceListRequest">GWDeviceListRequest</a></li>
<li class="level2"><a href="#gws_GWDeviceListResponse">GWDeviceListResponse</a></li>
<li class="level2"><a href="#gws_GWLastValueRequest">GWLastValueRequest</a></li>
<li class="level2"><a href="#gws_GWLastValueResponse">GWLastValueResponse</a></li>
<li class="level2"><a href="#gws_GWNoticeRequest">GWNoticeRequest</a></li>
</ul>
</li>
<li class="level1"><a href="#gws_dataexport">Data export messages</a><ul><li class="level2"><a href="#gws_GWSensorDataExport">GWSensorDataExport</a></li>
<li class="level2"><a href="#gws_GWSensorDataConfirm">GWSensorDataConfirm</a></li>
</ul>
</li>
<li class="level1"><a href="#gws_serverpair">Pairing requests from server</a><ul><li class="level2"><a href="#gws_GWListenRequest">GWListenRequest</a></li>
<li class="level2"><a href="#gws_GWDeviceAcceptRequest">GWDeviceAcceptRequest</a></li>
<li class="level2"><a href="#gws_GWUnpairRequest">GWUnpairRequest</a></li>
<li class="level2"><a href="#gws_GWUnpairResponse">GWUnpairResponse</a></li>
</ul>
</li>
<li class="level1"><a href="#gws_serverreq">Other requests from server</a><ul><li class="level2"><a href="#gws_GWSetValueRequest">GWSetValueRequest</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="gws_protocol_introduction"></a>
Introduction</h1>
<p>Gateway Server communicates with BeeeOn Gateways using a specific JSON-based protocol where each message contains a single JSON object. Every message contains field <code>message_type</code> that specifies semantics of the message. Most communication consists of the <em>request-response</em> model. To overcome issues with unreliable transport protocols, certain responses might be acknowladged by a separate <em>ack</em> message.</p>
<h1><a class="anchor" id="gws_protocol_initial"></a>
Initial sequence</h1>
<p>Every time when a BeeeOn Gateway connects with the remote server, a common pattern of messages is exchanged:</p>
<ol type="1">
<li>Gateway sends <code>gateway_register</code>.</li>
<li>Server replies <code>gateway_accepted</code>.</li>
<li>Gatewaysends <code>device_list_request</code> (usually multiple times for different prefixes).</li>
<li>Server replies <code>device_list_response</code> (for each request).</li>
<li>After that, usually, Gateway periodically sends <code>sensor_data_export</code> while expecting the <code>sensor_data_confirm</code> as an acknowladge.</li>
</ol>
<h1><a class="anchor" id="gws_protocol_command"></a>
Command requests</h1>
<p>There are certain commands that a user might want to execute by a gateway. E.g. when a new device is to be added into the system, she would ask the appropriate gateway to discover all unpaired/unknown devices around and than select the one (or ones) to pair with the BeeeOn system. This would lead to the following message sequence:</p>
<ol type="1">
<li>Server sends <code>listen_request</code>.</li>
<li>Gateway replies <code>generic_response</code> with result <code>ACCEPTED</code> (0).</li>
<li>Gateway sends <code>new_device_request</code> for each discovered device.</li>
<li>Server replies <code>generic_response</code> with result <code>SUCCESS</code> (1) for each known device and <code>FAILED</code> (2) for each unknown devices.</li>
<li>When the discovery finishes, Gateway sends <code>generic_response</code> with result <code>SUCCESS</code> (1) or <code>FAILED</code> (2) according to the status of the operation.</li>
</ol>
<p>Note that in this case, the <code>FAILED</code> result does not necessarily mean that the <em>discovery</em> operation entirely failed. The operation could failed just partially which is currently not covered by the protocol.</p>
<p>The example above illustrates how the request-response system works and that both sides can issue requests.</p>
<p>At point 5., the gateway should reply with <code>response_with_ack</code> that would ask the server to confirm that it has received the response. In that case, the message of type <code>generic_ack</code> would expected by the Gateway.</p>
<h1><a class="anchor" id="gws_protocol_issues"></a>
Known issues</h1>
<p>There are few issues included in the protocol that have been introduced either by a bad design or bad implementation and should be resolved in the future:</p>
<ul>
<li>It is not possible to signalize a partial failure, especially for the device discovery operation where a single device manager can fail while all the others work properly.</li>
<li>The message <code>response_with_ack</code> seems to be bad by design. Each response should probably has a flag named e.g. <code>ack_required</code>. Thus, any response could be acknowladged if necessary.</li>
<li>Messages <code>last_value_request</code> and <code>last_value_response</code> are obsolete and should not be used anymore. Thus, it might be possible to remove them entirely in the future.</li>
<li>Message <code>ping_request</code> is never used. Instead, the WebSocket PING frames are utilized for the same purpose. The message should be removed in the future.</li>
<li>There is no way how to report description of failures to the server.</li>
</ul>
<h1><a class="anchor" id="gws_registration"></a>
Registration with server</h1>
<p>Each gateway must first register itself with the remote server. The server confirms that the gateway was accepted and can send more messages. Otherwise, the connection would be closed by the server.</p>
<h2><a class="anchor" id="gws_GWGatewayRegister"></a>
GWGatewayRegister</h2>
<p>Represents message sent by the gateway after connecting to the server. Message is intended to gateway registration on the server.</p>
<p>Server confirms successful registration with message GWGatewayAccepted.</p>
<p>An example of a registration message: </p><pre>
{
  "message_type": "gateway_register",
  "gateway_id": "1875034586645818",
  "version": "v2017.01",
  "ip_address": "192.168.0.1"
}
</pre><h2><a class="anchor" id="gws_GWGatewayAccepted"></a>
GWGatewayAccepted</h2>
<p>Represents message sent by the server to the gateway after successful registration.</p>
<p>An example message: </p><pre>
{
  "message_type": "gateway_accepted"
}
</pre><h1><a class="anchor" id="gws_generic"></a>
Generic messages</h1>
<p>Many commands does not require any special responses. For that purpose, it is possible to respond with one of the generic response messages.</p>
<h2><a class="anchor" id="gws_GWResponse"></a>
GWResponse</h2>
<p>Represents a response to a request message (subclass of a GWRequest). The GWResponse can be used alone as a generic response or inherited by a more specific response object.</p>
<p>The GWResponse contains unique identifier intended to match a response to a proper request.</p>
<p>The entry "status" is currently represented as integer. It is however possible to use also string representation, any of:</p>
<ul>
<li>"accepted" (0)</li>
<li>"success" (1)</li>
<li>"failed" (2)</li>
<li>"success_partial" (3)</li>
</ul>
<p>The string representation should be preferred over numbers. The integer representation is treated as obsolete.</p>
<p>Each response can have an optional entry "ack_expected" of type bool. If its value is true then the response is expected to be acknowladged explicitly by a GWAck message. Unless it is acknowladged this way, the client considers such response to be undelivered and may decide to retransmit the response.</p>
<p>An example (generic) response: </p><pre>
{
  "id": "b036b7f7-47a1-4bea-9fa3-6024e8263dcd",
  "message_type": "generic_response",
  "status": "success"
}
</pre><p>An example (generic) response requiring acknowladge: </p><pre>
{
  "id": "b036b7f7-47a1-4bea-9fa3-6024e8263dcd",
  "message_type": "generic_response",
  "status": "failed",
  "ack_expected": true
}
</pre><h2><a class="anchor" id="gws_GWResponseWithAck"></a>
GWResponseWithAck</h2>
<p><b>Deprecated.</b> Represents a response to a request message (subclass of a GWRequest), that requires acknowledgement (GWAck). In the future, just use a regular GWResponse and set ackRequired property to true.</p>
<h2><a class="anchor" id="gws_GWAck"></a>
GWAck</h2>
<p>Represents an acknowledgement, that a response of the given id and status has been really delivered. It is intended to handle unreliable network connections.</p>
<p>There can be more responses with the same id, so status is also needed to identify and confirm proper response.</p>
<p>An example of an ack message: </p><pre>
{
  "message_type": "generic_ack",
  "id": "4c42288f-d592-4d6a-b401-0c2ef47c6d6d",
  "status": 0
}
</pre><h1><a class="anchor" id="gws_gwtoserver"></a>
Requests from gateway</h1>
<p>Gateway can requests certain services from the server as well as notifying server about certain events. This sections describes such commands.</p>
<h2><a class="anchor" id="gws_GWNewDeviceRequest"></a>
GWNewDeviceRequest</h2>
<p>Represents a message sent by the gateway to the server after discovering new device in the sensoric network.</p>
<p>The message contains unique device identification, its product name along with vendor, refresh time and types of device modules.</p>
<p>There are some optional properties each device can report about itself. These are currently: "name" (name of the device instance, not product name), "firmware" (string that informs about firmware version), "ip_address", "mac_address", "serial_number".</p>
<p>Response to this request is the generic response GWResponse.</p>
<p>An example message: </p><pre>
{
  "id": "87e63e94-4954-4600-9c37-348c7626d469",
  "message_type": "new_device_request",
  "device_id": "0xa100000000000001",
  "product_name": "Temperature Sensor",
  "vendor": "Brno University of Technology",
  "refresh_time": 30,
  "serial_number": "1234567",
  "firmware": "v125667",
  "module_types": [
     {
       "type": "temperature",
       "attributes": ["inner"]
     },
     {
       "type": "temperature",
       "attributes": ["outer"]
     },
     {
       "type": "battery",
       "attributes": []
     },
     {
       "type": "enum",
       "subtype": "BLINK_MODE",
       "attributes": ["controllable"]
     }
  ]
}
</pre><h2><a class="anchor" id="gws_GWNewDeviceGroupRequest"></a>
GWNewDeviceGroupRequest</h2>
<p>Represents a message sent by the gateway to the server after discovering a device consisting of a group of subdevices in the sensoric network. Example of the device may be VPT regulator that consists of 4 zones and a boiler. Vendor name stored in message has to be same for all devices.</p>
<p>Response to this request is the generic response GWResponse.</p>
<p>An example message: </p><pre>
{
  "message_type": "new_device_group_request",
  "id": "bddc7e1d-2578-40c0-8d42-43f818fef401",
  "group_name": "Control Center",
  "vendor": "Example Control Company",
  "devices": [
    {
      "device_id": "0xa100000000000001",
      "product_name": "Control Panel"
      "module_types": [
        {
          "type": "on_off",
          "attributes": ["controllable"]
        },
        {
          "type": "on_off",
          "attributes": ["controllable"]
        }
      ],
      "refresh_time": -1
    },
    {
      "device_id": "0xa100000000000002",
      "product_name": "Probe",
      "module_types": [
        {
          "type": "temperature",
          "attributes": ["inner"]
        },
        {
          "type": "humidity",
          "attributes": ["inner"]
        }
      ],
      "refresh_time": 120
    }
  ]
}
</pre><h2><a class="anchor" id="gws_GWDeviceListRequest"></a>
GWDeviceListRequest</h2>
<p>Represents a message sent by the gateway to the server, intended to requests a list of paired devices with a specific prefix.</p>
<p>GWDeviceListRequest represents response to this request.</p>
<p>An example message: </p><pre>
{
  "id": "ffd0da59-5f6d-4363-b2ad-afa95ef85d59",
  "message_type": "device_list_request",
  "device_prefix": "vdev"
}
</pre><h2><a class="anchor" id="gws_GWDeviceListResponse"></a>
GWDeviceListResponse</h2>
<p>Represents a message sent byt the server to the gateway as a response to the GWDeviceListRequest.</p>
<p>The message contains a list of paired devices with a specific prefix.</p>
<p>For each device, there is an optional section under key <em>config</em>. Here, some configuration options might be available. Currently, the well known keys are: "refresh_time", "ip_address", "password".</p>
<p>An example message: </p><pre>
{
  "id": "60775a50-d91c-4325-89b1-283e38bd60b2",
  "message_type": "device_list_response",
  "status": 1,
  "devices": [
      {"device_id": "0xa300000000000001"}
  ],
  "values": {
      "0xa300000000000001": {
          "0": 0,
          "1": 10.0
      }
  },
  "config": {
     "0xa300000000000001": {
        "regresh_time": "30",
        "password": "super-secret",
        "ip-address": "10.0.0.1"
     }
  }
}
</pre><h2><a class="anchor" id="gws_GWLastValueRequest"></a>
GWLastValueRequest</h2>
<p><b>Deprecated.</b> Represents a message sent by the gateway to the server, intended to requests a last known value of a device module.</p>
<p>GWLastValueResponse represents response to this request.</p>
<h2><a class="anchor" id="gws_GWLastValueResponse"></a>
GWLastValueResponse</h2>
<p><b>Deprecated.</b> Represents a message sent by the server to the gateway as a response to the GWLastValueRequest.</p>
<p>The message contains the last known value of a device module.</p>
<h2><a class="anchor" id="gws_GWNoticeRequest"></a>
GWNoticeRequest</h2>
<p>GWNoticeRequest allows a gateway to send a notice about something that happen. It can report progress information, error details, hints, etc. Each notice is defined by the following properties:</p>
<ul>
<li>at - time when the message (or source event) has occoured</li>
<li>severity - describes importance of the message: info, warn or error</li>
<li>key - key that defines the message (intended to be translated to client)</li>
<li>context - context that can be used to construct the client message</li>
</ul>
<p>All message should be designed with multi-locale environment in mind. Thus, the key and context are kept separately and should be tranformed to the appropriate user message on the presentation layer.</p>
<p>An example message: </p><pre>
{
  "id": "603a5085-1b00-4c5e-ac70-dde674a49b0c",
  "message_type": "notice_request",
  "at": 1546882536019124,
  "severity": "info",
  "key": "press_button_on_device",
  "context": {
    "device_id": "0xa3123456abcd01234",
    "gateway_id": "12437773180129",
    "button": "red"
  }
}
</pre><h1><a class="anchor" id="gws_dataexport"></a>
Data export messages</h1>
<p>Paired sensors reports measured data to the server. This usually happens periodically or based on some value's change. Such data is exported via <code>sensor_data_export</code> message. Every message must be confirmed by replying <code>sensor_data_confirm</code>.</p>
<h2><a class="anchor" id="gws_GWSensorDataExport"></a>
GWSensorDataExport</h2>
<p>Represents a message sent by the gateway to the server intended to export measured sensor data.</p>
<p>The GWSensorDataExport contains unique identifier intended to match a proper GWSensorDataConfirm (confirmation, that the server accepted exported measured sensor data). After the GWSensorDataExport is sent, the gateway expect a confirmation with the given id.</p>
<p>An example message: </p><pre>
{
  "id": "9990944f-e53d-47dd-8b46-a797c8ccec10",
  "message_type": "sensor_data_export",
  "data": {
    {
      "device_id": "0xa300000000000001",
      "timestamp": 1538575474123012,
      "values": [
        {
          "module_id": 0,
          "value": 25.6
        },
        {
          "module_id": 1,
          "value": 100.0
        }
      ]
    }
  }
}
</pre><h2><a class="anchor" id="gws_GWSensorDataConfirm"></a>
GWSensorDataConfirm</h2>
<p>Represents message sent by the server to the gateway intended to confirm, that the server accepted exported sensor data represented by the GWSensorDataExport.</p>
<p>The GWSensorDataConfirm contains unique identifier intended to match a proper GWSensorDataExport.</p>
<p>An example message: </p><pre>
{
  "id": "9990944f-e53d-47dd-8b46-a797c8ccec10",
  "message_type": "sensor_data_confirm",
}
</pre><h1><a class="anchor" id="gws_serverpair"></a>
Pairing requests from server</h1>
<p>User can initiate device discovery process and confirm pairing of the discovered devices. This is accomplished by messages of type <code>list_request</code>. During the discovery, the gateway generates <code>new_device_request</code> messages to notify the server about new discovered or unpaired devices. User can select and confirm devices to be paired and used. In that case, the server requests the gateway to accept a selected device by message of type <code>device_accept_request</code>. To unpair a used device, the <code>unpair_request</code> message is used.</p>
<h2><a class="anchor" id="gws_GWListenRequest"></a>
GWListenRequest</h2>
<p>Represents a message sent by the server to the gateway, intended to start 'listening mode' on the gateway. In this mode, gateway can discover new devices from the sensoric network.</p>
<p>The listening mode has typically a limited duration. After the duration exceeds, the listening mode is automatically turned off.</p>
<p>An example message: </p><pre>
{
  "id": "c149f44a-ab44-459a-b18f-a5c33d3d3c3c",
  "message_type": "listen_request",
  "duration": 60
}
</pre><h2><a class="anchor" id="gws_GWDeviceAcceptRequest"></a>
GWDeviceAcceptRequest</h2>
<p>Represents a message sent by the server to the gateway, intended to inform gateway that the user accepted the discovered device. It means request to pair the device with the gateway.</p>
<p>Optionally, the refresh time can be configured by this command. Also, the section "config" can contain certain configuration entries that might help to initialize the device.</p>
<p>An example message: </p><pre>
{
  "id": "603a5085-1b00-4c5e-ac70-dde674a49b0c",
  "message_type": "device_accept_request",
  "device_id": "0xa300000000000001"
  "refresh_time": "15",
  "config": {
     "ip-address": "192.168.0.1"
  }
}
</pre><h2><a class="anchor" id="gws_GWUnpairRequest"></a>
GWUnpairRequest</h2>
<p>Represents a message sent by the server to the gateway, intended to unpair a paired device from the gateway.</p>
<p>An example message: </p><pre>
{
  "id": "fe2ba7e3-5d93-4c11-bc36-8f0b2f0a7b1a",
  "message_type": "unpair_request",
  "device_id": "0xa300000000000002"
}
</pre><h2><a class="anchor" id="gws_GWUnpairResponse"></a>
GWUnpairResponse</h2>
<p>The unpair process might under certain circumstances unpair a different device then intended. The custom unpair response holds a list of IDs of devices unpaired by the unpair request. Depending on the server, it might be possible to use also generic GWResponse. But this class is better and should be preferred.</p>
<p>An example message: </p><pre>
{
  "id": "603a5085-1b00-4c5e-ac70-dde674a49b0c",
  "message_type": "unpair_response",
  "devices": {
     {"device_id": "0xa1012345aabbccdd"}
  }
}
</pre><h1><a class="anchor" id="gws_serverreq"></a>
Other requests from server</h1>
<p>Certain devices can be controlled remotely, e.g. lights can be turn on or off. To manipulate devices, the server can generate message of type <code>set_value_request</code>.</p>
<h2><a class="anchor" id="gws_GWSetValueRequest"></a>
GWSetValueRequest</h2>
<p>Represents a message sent by the server to the gateway, intended to change state of an active module on the device.</p>
<p>The message contains an identification of the device and its module, a value to be set and a timeout for which the value must be set or the operation end with failed.</p>
<p>An example message: </p><pre>
{
  "id": "a507755f-793f-4067-89bf-533fb73b6a41",
  "message_type": "set_value_request",
  "device_id": "0xa300000000000001",
  "module_id": "0",
  "timeout": 30,
  "value": 1.0
}
</pre> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
