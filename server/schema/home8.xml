<database name="home8">

	<table name="places">
		<column name="id" type="uuid" not-null="yes" />
		<column name="name" type="varchar" size="250" />

		<primary-key ref="id" />
	</table>

	<table name="gateways">
		<column name="id" type="int64" not-null="yes" />
		<column name="name" type="varchar" size="250" />
		<column name="place_id" type="uuid" />
		<column name="altitude" type="double" />
		<column name="latitude" type="double" />
		<column name="longitude" type="double" />

		<primary-key ref="id" />
		<foreign-key table="places" local="place_id" remote="id" />
	</table>

	<table name="locations">
		<column name="id" type="uuid" not-null="yes" />
		<column name="name" type="varchar" size="250" />
		<column name="place_id" type="uuid" />

		<primary-key ref="id" />
		<foreign-key table="places" local="place_id" remote="id" />
	</table>

	<table name="users">
		<column name="id" type="uuid" not-null="yes" />
		<column name="first_name" type="varchar" size="250" not-null="yes" />
		<column name="last_name" type="varchar" size="250" not-null="yes" />

		<primary-key ref="id" />
	</table>

	<table name="identities">
		<column name="id" type="uuid" not-null="yes" />
		<column name="email" type="varchar" size="250" not-null="yes" />

		<primary-key ref="id" />
		<unique name="unique_identity" ref="email" />
	</table>

	<table name="verified_identities">
		<column name="id" type="uuid" not-null="yes" />
		<column name="identity_id" type="uuid" not-null="yes" />
		<column name="user_id" type="uuid" not-null="yes" />
		<column name="provider" type="varchar" size="250" not-null="yes" />
		<column name="picture" type="varchar" size="250" />
		<column name="access_token" type="varchar" size="250" />

		<primary-key ref="id" />
		<foreign-key table="identities" local="identity_id" remote="id" />
		<foreign-key table="users" local="user_id" remote="id" />

		<unique name="unique_verified_identity">
			<ref>identity_id</ref>
			<ref>provider</ref>
		</unique>
	</table>

	<table name="roles_in_place">
		<column name="id" type="uuid" not-null="yes" />
		<column name="place_id" type="uuid" not-null="yes" />
		<column name="identity_id" type="uuid" not-null="yes" />
		<column name="level" type="smallint" not-null="yes" />

		<primary-key ref="id" />
		<foreign-key table="places" local="place_id" remote="id" />
		<foreign-key table="identities" local="identity_id" remote="id" />

		<check name="check_valid_level" expression="level &gt;= 0 AND level &lt;= 100" />
	</table>

	<table name="devices">
		<column name="id" type="int64" not-null="yes" />
		<column name="gateway_id" type="int64" not-null="yes" />
		<column name="location_id" type="uuid" />
		<column name="name" type="varchar" size="250" not-null="yes" />
		<column name="type" type="smallint" not-null="yes" />
		<column name="refresh" type="integer" default="10" not-null="yes" />
		<column name="battery" type="smallint" />
		<column name="signal" type="smallint" />
		<column name="first_seen" type="bigint" not-null="yes" />
		<column name="last_seen" type="bigint" not-null="yes" />
		<column name="active_since" type="bigint" />

		<primary-key>
			<ref>id</ref>
			<ref>gateway_id</ref>
		</primary-key>

		<foreign-key table="gateways" local="gateway_id" remote="id" />
		<foreign-key table="locations" local="location_id" remote="id" />

		<check name="check_id_positive" expression="id &gt;= 0" />
		<check name="check_seen_valid" expression="first_seen &lt;= last_seen" />
		<check name="check_active_valid"
			expression="active_since IS NULL OR first_seen &lt;= active_since" />
		<check name="check_battery_valid"
			expression="battery IS NULL OR (battery &gt;= 0 AND battery &lt;= 100)" />
		<check name="check_singal_valid"
			expression="signal IS NULL OR (signal &gt;= 0 AND signal &lt;= 100)" />
	</table>

</database>
