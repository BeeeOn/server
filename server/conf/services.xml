<!DOCTYPE system SYSTEM "services.dtd">
<system>
	<services>
		<instance name="ui" class="BeeeOn::LoopRunner">
			<add name="loops" ref="uiModule" />
		</instance>

		<instance name="uiModule" class="BeeeOn::UIServerModule">
			<set name="sessionVerifier" ref="sessionVerifier" />
			<set name="userService" ref="userService" />
			<set name="authHandler" ref="authHandler" />
			<set name="deviceService" ref="deviceService" />
			<set name="port" number="${ui.port}" />
		</instance>

		<instance name="authHandler" class="BeeeOn::RestAuthHandler">
			<set name="authService" ref="authService" />
		</instance>

		<instance name="sessionVerifier" class="BeeeOn::SessionVerifier">
			<set name="sessionManager" ref="sessionManager" />
		</instance>

		<instance name="xmlui" class="BeeeOn::LoopRunner">
			<add name="loops" ref="xmluiServer" />
		</instance>

		<instance name="xmluiServer" class="BeeeOn::SocketServer">
			<set name="connectionFactory" ref="xmluiFactory" />
			<set name="sslConfig" ref="xmluiSSLServer" if-yes="${xmlui.ssl.enable}" />
			<set name="backlog" number="64" />
			<set name="maxThreads" number="64" />
			<set name="maxQueued" number="64" />
			<set name="threadIdleTime" number="8" />
			<set name="threadPriority" text="normal" />
			<set name="port" number="${xmlui.port}" />
		</instance>

		<instance name="xmluiFactory"
				class="BeeeOn::XmlRequestHandlerFactory">
			<add name="resolvers" ref="authXmlHandler" />
			<add name="resolvers" ref="gatewayXmlHandler" />
			<add name="resolvers" ref="deviceXmlHandler" />
			<add name="resolvers" ref="sensorXmlHandler" />
			<add name="resolvers" ref="locationXmlHandler" />
			<add name="resolvers" ref="profileXmlHandler" />
			<add name="resolvers" ref="roleXmlHandler" />
			<add name="resolvers" ref="anyXmlHandler" />
		</instance>

		<instance name="anyXmlHandler"
				class="BeeeOn::XmlUI::AnyXmlHandlerResolver" />

		<instance name="authXmlHandler"
				class="BeeeOn::XmlUI::AuthXmlHandlerResolver">
			<set name="authService" ref="authService" />
		</instance>

		<instance name="gatewayXmlHandler"
				class="BeeeOn::XmlUI::GatewayXmlHandlerResolver">
			<set name="gatewayService" ref="gatewayService" />
			<set name="sessionManager" ref="sessionManager" />
		</instance>

		<instance name="locationXmlHandler"
				class="BeeeOn::XmlUI::LocationXmlHandlerResolver">
			<set name="locationService" ref="locationService" />
			<set name="sessionManager" ref="sessionManager" />
		</instance>

		<instance name="deviceXmlHandler"
				class="BeeeOn::XmlUI::DeviceXmlHandlerResolver">
			<set name="deviceService" ref="deviceService" />
			<set name="sessionManager" ref="sessionManager" />
		</instance>

		<instance name="sensorXmlHandler"
				class="BeeeOn::XmlUI::SensorXmlHandlerResolver">
			<set name="sensorHistoryService" ref="sensorHistoryService" />
			<set name="sessionManager" ref="sessionManager" />
		</instance>

		<instance name="profileXmlHandler"
				class="BeeeOn::XmlUI::ProfileXmlHandlerResolver">
			<set name="identityService" ref="identityService" />
			<set name="sessionManager" ref="sessionManager" />
		</instance>

		<instance name="roleXmlHandler"
				class="BeeeOn::XmlUI::RoleXmlHandlerResolver">
			<set name="roleService" ref="roleService" />
			<set name="sessionManager" ref="sessionManager" />
		</instance>

		<instance name="uiMockInit"
				class="BeeeOn::UIMockInit"
				init="early">
			<set name="userDao" ref="userDao" />
			<set name="gatewayDao" ref="gatewayDao" />
			<set name="locationDao" ref="locationDao" />
			<set name="deviceDao" ref="deviceDao" />
			<set name="identityDao" ref="identityDao" />
			<set name="verifiedIdentityDao" ref="verifiedIdentityDao" />
			<set name="sensorHistoryDao" ref="sensorHistoryDao" />
			<set name="deviceInfoProvider" ref="deviceInfoProvider" />
			<set name="transactionManager" ref="transactionManager" />
		</instance>

		<!-- Bussiness layer -->

		<instance name="userService" class="BeeeOn::UserService">
			<set name="userDao" ref="userDao" />
			<set name="transactionManager" ref="transactionManager" />
		</instance>

		<instance name="authService" class="BeeeOn::AuthService">
			<set name="userDao" ref="userDao" />
			<set name="identityDao" ref="identityDao" />
			<set name="verifiedIdentityDao" ref="verifiedIdentityDao" />
			<set name="sessionManager" ref="sessionManager" />
			<set name="notificationDispatcher" ref="notificationDispatcher" />
			<set name="transactionManager" ref="transactionManager" />
			<add name="providers" ref="googlePermitAuthProvider" if-yes="${ui.debug}" />
			<add name="providers" ref="googleAuthProvider" />
		</instance>

		<instance name="deviceService" class="BeeeOn::DeviceService">
			<set name="deviceDao" ref="deviceDao" />
			<set name="gatewayRPC" ref="gatewayRPC" />
			<set name="accessPolicy" ref="accessPolicy" />
			<set name="transactionManager" ref="transactionManager" />
		</instance>

		<instance name="gatewayService" class="BeeeOn::GatewayService">
			<set name="gatewayDao" ref="gatewayDao" />
			<set name="roleInGatewayDao" ref="roleInGatewayDao" />
			<set name="identityDao" ref="identityDao" />
			<set name="verifiedIdentityDao" ref="verifiedIdentityDao" />
			<set name="gatewayRPC" ref="gatewayRPC" />
			<set name="accessPolicy" ref="accessPolicy" />
			<set name="transactionManager" ref="transactionManager" />
		</instance>

		<instance name="locationService"
				class="BeeeOn::LocationService">
			<set name="locationDao" ref="locationDao" />
			<set name="gatewayDao" ref="gatewayDao" />
			<set name="accessPolicy" ref="accessPolicy" />
			<set name="transactionManager" ref="transactionManager" />
		</instance>

		<instance name="identityService" class="BeeeOn::IdentityService">
			<set name="identityDao" ref="identityDao" />
			<set name="verifiedIdentityDao" ref="verifiedIdentityDao" />
			<set name="transactionManager" ref="transactionManager" />
		</instance>

		<instance name="roleService" class="BeeeOn::RoleService">
			<set name="identityDao" ref="identityDao" />
			<set name="gatewayDao" ref="gatewayDao" />
			<set name="roleInGatewayDao" ref="roleInGatewayDao" />
			<set name="accessPolicy" ref="accessPolicy" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="notificationDispatcher" ref="notificationDispatcher" />
		</instance>

		<instance name="sensorHistoryService" class="BeeeOn::SensorHistoryService">
			<set name="sensorHistoryDao" ref="sensorHistoryDao" />
			<set name="deviceDao" ref="deviceDao" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="accessPolicy" ref="accessPolicy" />
		</instance>

		<instance name="typeInfoProvider" class="BeeeOn::TypeInfoProvider">
			<set name="typesFile" text="${spec.types.xml}" />
		</instance>

		<instance name="deviceInfoProvider" class="BeeeOn::DeviceInfoProvider">
			<set name="typeInfoProvider" ref="typeInfoProvider" />
			<set name="devicesFile" text="${spec.devices.xml}" />
		</instance>

		<instance name="loggingObserver" class="BeeeOn::LoggingObserver" />

		<instance name="notificationDispatcher"
				class="BeeeOn::NotificationDispatcher">
			<add name="observer" ref="loggingObserver" />
		</instance>

		<instance name="accessPolicy"
				class="BeeeOn::DefaultAccessPolicy">
			<set name="userDao" ref="userDao" />
			<set name="gatewayDao" ref="gatewayDao" />
			<set name="locationDao" ref="locationDao" />
			<set name="deviceDao" ref="deviceDao" />
			<set name="roleInGatewayDao" ref="sqlRoleInGatewayDao" />
		</instance>

		<!-- Data access layer -->

		<instance name="sessionManager" class="BeeeOn::SessionManager">
			<set name="secureRandomProvider"
				ref="pocoRandomProvider" />
			<set name="sessionExpireTime" number="${session.expire}" />
			<set name="maxUserSessions" number="${session.maxPerUser}" />
		</instance>

		<instance name="googlePermitAuthProvider"
				class="BeeeOn::PermitAuthProvider">
			<set name="resultProvider" text="google" />
		</instance>

		<instance name="googleAuthProvider"
				class="BeeeOn::GoogleAuthProvider">
			<set name="client_secret" text="${google.client_secret}"/>
			<set name="client_id" text="${google.client_id}"/>
			<set name="redirect_uri" text="${google.redirect_uri}"/>
			<set name="sslConfig" ref="googleOAuthSSL"/>
		</instance>

		<instance name="pocoRandomProvider"
				class="BeeeOn::PocoRandomProvider" />

		<instance name="mockRandomProvider"
				class="BeeeOn::MockRandomProvider">
			<set name="nextRandom" text="0123456789abcdef" />
		</instance>

		<instance name="insecureRandomProvider"
				class="BeeeOn::InsecureRandomProvider">
			<set name="providerImpl" ref="mockRandomProvider" />
		</instance>

		<instance name="nullGatewayRPC" class="BeeeOn::NullGatewayRPC" />
		<instance name="fakeGatewayRPC" class="BeeeOn::FakeGatewayRPC">
			<set name="deviceDao" ref="deviceDao" />
		</instance>

		<alias name="gatewayRPC" ref="fakeGatewayRPC" />

		<alias name="userDao" ref="sqlUserDao" />
		<alias name="gatewayDao" ref="sqlGatewayDao" />
		<alias name="locationDao" ref="sqlLocationDao" />
		<alias name="deviceDao" ref="sqlDeviceDao" />
		<alias name="identityDao" ref="sqlIdentityDao" />
		<alias name="verifiedIdentityDao" ref="sqlVerifiedIdentityDao" />
		<alias name="roleInGatewayDao" ref="sqlRoleInGatewayDao" />
		<alias name="sensorHistoryDao" ref="sqlSensorHistoryDao" />

		<instance name="pocoDaoManager"
				class="BeeeOn::PocoDaoManager">
			<set name="connector" ref="${database.backend}Connector" />
			<set name="connectionString" text="${database.connector}" />
			<set name="maxSessions" number="${database.pool}" />
			<set name="initScript" text="${database.init}" />
		</instance>

		<instance name="pocoTransactionManager"
				class="BeeeOn::PocoTransactionManager">
			<set name="daoManager" ref="pocoDaoManager" />
		</instance>

		<alias name="transactionManager" ref="pocoTransactionManager" />

		<instance name="sqliteConnector"
				class="BeeeOn::PocoSQLiteConnectorLoader" />

		<instance name="sqlUserDao" class="BeeeOn::PocoSQLUserDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="sqlIdentityDao" class="BeeeOn::PocoSQLIdentityDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="sqlVerifiedIdentityDao"
				class="BeeeOn::PocoSQLVerifiedIdentityDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="sqlRoleInGatewayDao"
				class="BeeeOn::PocoSQLRoleInGatewayDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="sqlGatewayDao" class="BeeeOn::PocoSQLGatewayDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="sqlLocationDao" class="BeeeOn::PocoSQLLocationDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="sqlDeviceDao" class="BeeeOn::PocoSQLDeviceDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="deviceInfoProvider" ref="deviceInfoProvider" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="sqlSensorHistoryDao" class="BeeeOn::PocoSQLSensorHistoryDao">
			<set name="daoManager" ref="pocoDaoManager" />
			<set name="transactionManager" ref="transactionManager" />
			<set name="sqlLoader" ref="queries" />
		</instance>

		<instance name="queries" class="BeeeOn::SQLLoader">
			<set name="database" text="home8" />
			<add name="file" text="${database.queries}" />
		</instance>

		<!-- SSL configurations -->

		<instance name="xmluiSSLServer" class="BeeeOn::SSLServer">
			<set name="certificate" text="${xmlui.ssl.certificate}" />
			<set name="privateKey" text="${xmlui.ssl.key}" />
			<set name="caLocation" text="${xmlui.ssl.authority}" />
			<set name="verificationMode" text="${xmlui.ssl.verify_level}" />
			<set name="loadDefaultCA" text="false" />
		</instance>

		<instance name="googleOAuthSSL" class="BeeeOn::SSLClient">
			<set name="verificationMode" text="${google.ssl.verify_mode}" />
			<set name="caLocation" text="${google.ssl.authority}" />
			<set name="disabledProtocols" text="sslv2,sslv3,tlsv1,tlsv1_1" />
		</instance>

	</services>
</system>
